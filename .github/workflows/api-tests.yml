name: Namaz Bot CI/CD

on:
  push:
    branches: [ main ]
  schedule:
    - cron: '0 */6 * * *'

jobs:
  ci-cd-pipeline:
    runs-on: ubuntu-latest
    
    steps:
    # ==================== CI Ð§ÐÐ¡Ð¢Ð¬ ====================
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        
    - name: Install Newman
      run: npm install -g newman newman-reporter-html
      
    - name: Run API Tests
      run: |
        newman run "collections/Namaz Bot API Tests.postman_collection.json" \
        -e "environments/Namaz Bot Environment.postman_environment.json" \
        -r cli,html
        
    - name: Upload HTML Report
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: namaz-bot-report
        path: newman/
    
    # ==================== CD Ð§ÐÐ¡Ð¢Ð¬ ====================
    - name: Install SSH tools
      if: success()
      run: |
        sudo apt-get update
        sudo apt-get install -y sshpass
        
    - name: Deploy Bot to Server
      if: success()
      run: |
        echo "ðŸš€ Ð”ÐµÐ¿Ð»Ð¾Ð¹ Ð±Ð¾Ñ‚Ð° Ð½Ð° ÑÐµÑ€Ð²ÐµÑ€..."
        sshpass -p "${{ secrets.SERVER_PASSWORD }}" scp -o StrictHostKeyChecking=no \
          namaz_bot.py ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}:/root/
        
        echo "ðŸ” ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ñ‚ÐµÐºÑƒÑ‰Ð¸Ðµ Ð¿Ñ€Ð¾Ñ†ÐµÑÑÑ‹..."
        sshpass -p "${{ secrets.SERVER_PASSWORD }}" ssh -o StrictHostKeyChecking=no \
          ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} "ps aux | grep namaz_bot.py | grep -v grep || echo 'ÐŸÑ€Ð¾Ñ†ÐµÑÑÑ‹ Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½Ñ‹'"
        
        echo "ðŸ” ÐÐºÐºÑƒÑ€Ð°Ñ‚Ð½Ð¾ Ð¾ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Ð±Ð¾Ñ‚Ð°..."
        sshpass -p "${{ secrets.SERVER_PASSWORD }}" ssh -o StrictHostKeyChecking=no \
          ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} "pkill -f namaz_bot.py; exit 0"
        
        echo "â³ Ð–Ð´ÐµÐ¼ 2 ÑÐµÐºÑƒÐ½Ð´Ñ‹..."
        sleep 2
        
        echo "ðŸ”„ Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ Ð½Ð¾Ð²Ñ‹Ð¹ Ð±Ð¾Ñ‚..."
        sshpass -p "${{ secrets.SERVER_PASSWORD }}" ssh -o StrictHostKeyChecking=no \
          ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} "cd /root && nohup python3 namaz_bot.py > bot.log 2>&1 &"
        
        echo "âœ… Ð”ÐµÐ¿Ð»Ð¾Ð¹ Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½!"
