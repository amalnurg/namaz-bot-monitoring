name: Namaz Bot CI/CD

on:
  push:
    branches: [ main ]
  schedule:
    - cron: '0 */6 * * *'

jobs:
  ci-cd-pipeline:
    runs-on: ubuntu-latest
    
    steps:
    # ==================== CI –ß–ê–°–¢–¨ ====================
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        
    - name: Install Newman
      run: npm install -g newman newman-reporter-html
      
    - name: Run API Tests
      run: |
        newman run "collections/Namaz Bot API Tests.postman_collection.json" \
        -e "environments/Namaz Bot Environment.postman_environment.json" \
        -r cli,html
        
    - name: Upload HTML Report
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: namaz-bot-report
        path: newman/
    
    # ==================== CD –ß–ê–°–¢–¨ ====================
    - name: Install SSH tools
      if: success()
      run: |
        sudo apt-get update
        sudo apt-get install -y sshpass
        
    - name: Test SSH Connection
      if: success()
      run: |
        echo "üîç –¢–µ—Å—Ç–∏—Ä—É–µ–º SSH –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ..."
        sshpass -p "hUDnVz8dUYui+9" ssh -o StrictHostKeyChecking=no \
          root@109.73.203.214 "echo '‚úÖ SSH –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —Ä–∞–±–æ—Ç–∞–µ—Ç!' && whoami"
        
    - name: Deploy Bot to Server
      if: success()
      run: |
        echo "üöÄ –î–µ–ø–ª–æ–π –±–æ—Ç–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä..."
        sshpass -p "hUDnVz8dUYui+9" scp -o StrictHostKeyChecking=no \
          namaz_bot.py root@109.73.203.214:/root/
        
        echo "üîÅ –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å—Ç–∞—Ä—ã–π –±–æ—Ç..."
        sshpass -p "hUDnVz8dUYui+9" ssh -o StrictHostKeyChecking=no \
          root@109.73.203.214 "pkill -f 'python3.*namaz_bot.py' || echo '–ë–æ—Ç –Ω–µ –±—ã–ª –∑–∞–ø—É—â–µ–Ω'"
        
        echo "üîÑ –ó–∞–ø—É—Å–∫–∞–µ–º –Ω–æ–≤—ã–π –±–æ—Ç..."
        sshpass -p "hUDnVz8dUYui+9" ssh -o StrictHostKeyChecking=no \
          root@109.73.203.214 "cd /root && nohup python3 namaz_bot.py > bot.log 2>&1 &"
        
        echo "‚úÖ –î–µ–ø–ª–æ–π –∑–∞–≤–µ—Ä—à–µ–Ω! –ë–æ—Ç –∑–∞–ø—É—â–µ–Ω."
        
    - name: Verify Deployment
      if: success()
      run: |
        echo "üîé –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –±–æ—Ç –∑–∞–ø—É—Å—Ç–∏–ª—Å—è..."
        sshpass -p "hUDnVz8dUYui+9" ssh -o StrictHostKeyChecking=no \
          root@109.73.203.214 "ps aux | grep namaz_bot.py | grep -v grep && echo '‚úÖ –ë–æ—Ç —Ä–∞–±–æ—Ç–∞–µ—Ç!' || echo '‚ùå –ë–æ—Ç –Ω–µ –∑–∞–ø—É—â–µ–Ω'"
