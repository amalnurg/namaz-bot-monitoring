name: CI/CD Pipeline

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  api-tests:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
    
    - name: Install Newman
      run: npm install -g newman newman-reporter-html
    
    - name: Run Postman API Tests
      env:
        TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
      run: |
        newman run "collections/Namaz Bot API Tests.postman_collection.json" \
          --environment-var "telegram_bot_token=$TELEGRAM_BOT_TOKEN" \
          --reporters cli,html \
          --reporter-html-export newman-report.html
    
    - name: Upload Test Report
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: api-test-report
        path: newman-report.html

  deploy:
    needs: api-tests
    runs-on: ubuntu-latest
    
    steps:
    - name: Install SSH dependencies
      run: sudo apt-get update && sudo apt-get install -y sshpass
    
    - name: Deploy to Production Server
      run: |
        echo "üöÄ Starting deployment to 109.73.203.214..."
        sshpass -p '${{ secrets.SERVER_PASSWORD }}' ssh -o StrictHostKeyChecking=no root@109.73.203.214 '
          cd /root/namaz-bot-monitoring
          echo "üì¶ Pulling latest changes..."
          git pull origin main
          
          echo "üîÑ Restarting bot service..."
          # –î–æ–±–∞–≤—å —Å—é–¥–∞ –∫–æ–º–∞–Ω–¥—ã –¥–ª—è –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞ –±–æ—Ç–∞
          
          echo "‚úÖ Deployment completed!"
          echo "üïí $(date)"
        '
        echo "üéâ Deployment finished successfully!"
