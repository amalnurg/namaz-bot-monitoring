name: API Tests and Deploy

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  postman-api-tests:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
    
    - name: Install Newman
      run: npm install -g newman
    
    - name: Run Postman API Tests
      env:
        TELEGRAM_BOT_TOKEN: \${{ secrets.TELEGRAM_BOT_TOKEN }}
      run: |
        echo "Running Postman API tests..."
        newman run "collections/Namaz Bot API Tests.postman_collection.json" \
          --env-var "telegram_bot_token=\$TELEGRAM_BOT_TOKEN"

  deploy-to-server:
    needs: postman-api-tests
    runs-on: ubuntu-latest
    
    steps:
    - name: Deploy to Production
      uses: appleboy/ssh-action@v1
      with:
        host: 109.73.203.214
        username: root
        key: \${{ secrets.SSH_PRIVATE_KEY }}
        script: |
          cd /root/namaz-bot-monitoring
          echo "üîÑ Pulling latest code..."
          git pull origin main
          echo "‚úÖ Code updated on server 109.73.203.214"
          # –î–æ–±–∞–≤—å –∫–æ–º–∞–Ω–¥—ã –¥–ª—è –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞ –±–æ—Ç–∞
          echo "üéâ Deployment completed!"
